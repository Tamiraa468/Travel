generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tour {
  id           String     @id @default(cuid())
  title        String
  slug         String     @unique
  description  String?
  days         Int
  priceFrom    Float
  mainImage    String?
  images       String[]   @default([])
  includes     String[]   @default([])
  highlights   String[]   @default([])
  mapEmbed     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  dates        TourDate[]
  bookings     Booking[]
}

model TourDate {
  id        String   @id @default(cuid())
  tour      Tour     @relation(fields: [tourId], references: [id])
  tourId    String
  startDate DateTime
  endDate   DateTime
  capacity  Int
  createdAt DateTime @default(now())
  bookings  Booking[]
}

model Customer {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String    @unique
  phone     String?
  createdAt DateTime  @default(now())
  bookings  Booking[]
}

model Booking {
  id           String    @id @default(cuid())
  tour         Tour      @relation(fields: [tourId], references: [id])
  tourId       String
  tourDate     TourDate  @relation(fields: [tourDateId], references: [id])
  tourDateId   String
  customer     Customer  @relation(fields: [customerId], references: [id])
  customerId   String
  quantity     Int
  totalPrice   Float
  status       BookingStatus @default(PENDING)
  payment      Payment?
  createdAt    DateTime  @default(now())
}

model Payment {
  id          String    @id @default(cuid())
  booking     Booking   @relation(fields: [bookingId], references: [id])
  bookingId   String    @unique
  provider    String
  providerId  String
  amount      Float
  currency    String    @default("USD")
  status      PaymentStatus @default(UNPAID)
  createdAt   DateTime  @default(now())
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

// RequestInfo model for handling tour information requests
model RequestInfo {
  id                 String            @id @default(cuid())
  fullName           String
  email              String
  phone              String?
  preferredStartDate DateTime?
  adults             Int               @default(1)
  children           Int               @default(0)
  message            String?
  tourId             String?
  tourName           String?
  tourPrice          Float?            // Total tour price
  advanceRequired    Float?            // 30% advance payment amount
  amountPaid         Float             @default(0) // Amount paid so far
  paymentStatus      RequestPaymentStatus @default(PENDING)
  bookingStatus      RequestBookingStatus @default(UNCONFIRMED)
  stripeSessionId    String?           // Stripe checkout session ID
  paypalOrderId      String?           // PayPal order ID
  paymentMethod      String?           // "stripe", "paypal", "bank_transfer"
  
  // Bank Transfer fields
  bankTransferRef    String?           // Unique reference for bank transfer
  bankTransferDate   DateTime?         // Date customer made the transfer
  bankTransferNote   String?           // Customer's note about transfer
  bankVerifiedAt     DateTime?         // When admin verified the payment
  bankVerifiedBy     String?           // Admin who verified
  
  marketingConsent   Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  
  @@index([email])
  @@index([createdAt])
  @@index([stripeSessionId])
  @@index([paypalOrderId])
  @@index([bankTransferRef])
}

enum RequestPaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum RequestBookingStatus {
  UNCONFIRMED
  CONFIRMED
  CANCELLED
}
