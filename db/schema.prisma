generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TOUR CATEGORY MODEL
// ============================================
model TourCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  image       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tours       Tour[]
}

// ============================================
// TOUR MODEL (UPDATED)
// ============================================
model Tour {
  id           String        @id @default(cuid())
  title        String
  slug         String        @unique
  description  String?
  days         Int
  priceFrom    Float
  mainImage    String?
  images       String[]      @default([])
  includes     String[]      @default([])
  excludes     String[]      @default([])  // NEW: Package excludes
  highlights   String[]      @default([])
  mapEmbed     String?
  mapImage     String?       // NEW: Map image URL (alternative to embed)
  season       String?       // NEW: Best season (e.g., "June-September")
  groupSize    String?       // NEW: e.g., "1-10 pax"
  activityLevel String?      // NEW: e.g., "Moderate", "Easy", "Challenging"
  isActive     Boolean       @default(true)
  isFeatured   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Relations
  category     TourCategory? @relation(fields: [categoryId], references: [id])
  categoryId   String?
  dates        TourDate[]
  bookings     Booking[]
  itinerary    TourItinerary[]
  priceTiers   TourPriceTier[]
  
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
}

// ============================================
// TOUR ITINERARY MODEL (Day-by-Day)
// ============================================
model TourItinerary {
  id          String   @id @default(cuid())
  tour        Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  tourId      String
  dayNumber   Int
  title       String
  description String
  meals       String?  // e.g., "B/L/D" or "Breakfast, Lunch, Dinner"
  accommodation String? // e.g., "Ger Camp", "Hotel"
  highlights  String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tourId, dayNumber])
  @@index([tourId])
}

// ============================================
// TOUR PRICE TIER MODEL (Group Size Pricing)
// ============================================
model TourPriceTier {
  id          String   @id @default(cuid())
  tour        Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  tourId      String
  minPax      Int
  maxPax      Int
  pricePerPerson Float
  description String?  // e.g., "Solo traveler", "Small group"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tourId])
}

model TourDate {
  id        String   @id @default(cuid())
  tour      Tour     @relation(fields: [tourId], references: [id])
  tourId    String
  startDate DateTime
  endDate   DateTime
  capacity  Int
  createdAt DateTime @default(now())
  bookings  Booking[]
}

model Customer {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String    @unique
  phone     String?
  createdAt DateTime  @default(now())
  bookings  Booking[]
}

model Booking {
  id           String    @id @default(cuid())
  tour         Tour      @relation(fields: [tourId], references: [id])
  tourId       String
  tourDate     TourDate  @relation(fields: [tourDateId], references: [id])
  tourDateId   String
  customer     Customer  @relation(fields: [customerId], references: [id])
  customerId   String
  quantity     Int
  totalPrice   Float
  status       BookingStatus @default(PENDING)
  payment      Payment?
  createdAt    DateTime  @default(now())
}

model Payment {
  id          String    @id @default(cuid())
  booking     Booking   @relation(fields: [bookingId], references: [id])
  bookingId   String    @unique
  provider    String
  providerId  String
  amount      Float
  currency    String    @default("USD")
  status      PaymentStatus @default(UNPAID)
  createdAt   DateTime  @default(now())
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

// ============================================
// INQUIRY MODEL (Lead Management - Inquiry-First Sales Model)
// ============================================
// PHILOSOPHY: This platform sells CONVERSATIONS, not instant bookings.
// Human trust and customization are the core value proposition.
// Tours are NOT directly bookable - website collects high-quality leads.
// Human agents close deals via email/WhatsApp after personalized quotation.
// ============================================
model Inquiry {
  id                 String            @id @default(cuid())
  
  // Contact Information
  fullName           String
  email              String
  phone              String?
  country            String?           // Customer's country for timezone/cultural context
  
  // Trip Preferences
  travelMonth        String?           // Preferred travel month (e.g., "July 2026")
  groupSize          String?           // e.g., "2 adults", "Family of 4"
  budgetRange        String?           // e.g., "$3000-5000", "Luxury", "Budget-friendly"
  message            String?           // Special requests, questions, interests
  
  // Tour Reference (optional - can be general inquiry)
  tourId             String?
  tourName           String?
  
  // Lead Pipeline Status
  // new → contacted → quoted → won → lost
  leadStatus         LeadStatus        @default(NEW)
  
  // Internal Notes (admin only)
  internalNotes      String?           // Private notes for sales team
  assignedTo         String?           // Sales agent handling this lead
  
  // Quotation & Deal Info (populated when status = quoted/won)
  quotedPrice        Float?            // Custom quoted price
  quoteCurrency      String            @default("USD")
  quoteValidUntil    DateTime?         // Quote expiration date
  quotePdfUrl        String?           // Link to PDF quotation
  
  // Payment Info (populated only when status = won)
  paymentStatus      RequestPaymentStatus @default(PENDING)
  amountPaid         Float             @default(0)
  stripeSessionId    String?           // Stripe checkout session ID (admin-generated)
  stripePaymentUrl   String?           // Stripe payment link sent to customer
  paymentMethod      String?           // "stripe", "bank_transfer"
  
  // Bank Transfer fields
  bankTransferRef    String?
  bankTransferDate   DateTime?
  bankTransferNote   String?
  bankVerifiedAt     DateTime?
  bankVerifiedBy     String?
  
  // Conversion to Booking (only when fully paid & confirmed)
  bookingId          String?           // Links to Booking record when converted
  convertedAt        DateTime?         // When lead was converted to booking
  
  // Timestamps & Tracking
  marketingConsent   Boolean           @default(false)
  source             String?           // "website", "referral", "social", etc.
  utmSource          String?           // UTM tracking
  utmMedium          String?
  utmCampaign        String?
  firstContactAt     DateTime?         // When agent first responded
  lastContactAt      DateTime?         // Last interaction timestamp
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  
  @@index([email])
  @@index([leadStatus])
  @@index([createdAt])
  @@index([assignedTo])
  @@index([stripeSessionId])
  @@index([bankTransferRef])
}

// Lead Pipeline Status
enum LeadStatus {
  NEW           // Just submitted, not yet contacted
  CONTACTED     // Agent has reached out
  QUOTED        // Custom quotation sent
  NEGOTIATING   // Back-and-forth on price/details
  WON           // Deal closed, payment pending/received
  LOST          // Did not convert
  ON_HOLD       // Temporarily paused (e.g., customer traveling later)
}

enum RequestPaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

// ============================================
// LEGACY: RequestInfo model (kept for backward compatibility)
// New inquiries should use the Inquiry model above
// ============================================
model RequestInfo {
  id                 String            @id @default(cuid())
  fullName           String
  email              String
  phone              String?
  preferredStartDate DateTime?
  adults             Int               @default(1)
  children           Int               @default(0)
  message            String?
  tourId             String?
  tourName           String?
  tourPrice          Float?
  advanceRequired    Float?
  amountPaid         Float             @default(0)
  paymentStatus      RequestPaymentStatus @default(PENDING)
  bookingStatus      RequestBookingStatus @default(UNCONFIRMED)
  stripeSessionId    String?
  paypalOrderId      String?
  paymentMethod      String?
  bankTransferRef    String?
  bankTransferDate   DateTime?
  bankTransferNote   String?
  bankVerifiedAt     DateTime?
  bankVerifiedBy     String?
  marketingConsent   Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  
  // Migration flag - marks if migrated to new Inquiry model
  migratedToInquiry  Boolean           @default(false)
  
  @@index([email])
  @@index([createdAt])
  @@index([stripeSessionId])
  @@index([paypalOrderId])
  @@index([bankTransferRef])
}

enum RequestBookingStatus {
  UNCONFIRMED
  CONFIRMED
  CANCELLED
}

// ============================================
// BLOG POST MODEL
// ============================================
model BlogPost {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  excerpt     String?
  content     String       // Rich text/markdown content
  coverImage  String?
  author      String?
  category    BlogCategory @default(NEWS)
  tags        String[]     @default([])
  isPublished Boolean      @default(false)
  publishedAt DateTime?
  views       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([slug])
  @@index([isPublished])
  @@index([category])
}

enum BlogCategory {
  NEWS
  FESTIVAL
  TRAVEL_GUIDE
  CULTURE
  ADVENTURE
  TIPS
}

// ============================================
// TESTIMONIAL MODEL
// ============================================
model Testimonial {
  id          String   @id @default(cuid())
  name        String
  country     String?
  avatar      String?
  rating      Int      @default(5) // 1-5 stars
  text        String
  tourName    String?
  travelDate  String?  // e.g., "July 2024"
  isApproved  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isApproved])
  @@index([isFeatured])
}

// ============================================
// FAQ MODEL
// ============================================
model FAQ {
  id          String      @id @default(cuid())
  question    String
  answer      String
  category    FAQCategory @default(GENERAL)
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([category])
  @@index([isActive])
}

enum FAQCategory {
  GENERAL
  BOOKING
  PAYMENT
  TRAVEL
  VISA
  ACCOMMODATION
  TRANSPORTATION
}

// ============================================
// TEAM MEMBER MODEL
// ============================================
model TeamMember {
  id          String   @id @default(cuid())
  name        String
  role        String
  bio         String?
  image       String?
  email       String?
  phone       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// CONTENT PAGE MODEL (For Why Mongolia, Travel Guide, etc.)
// ============================================
model ContentPage {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique
  content     String          // Rich text/markdown
  excerpt     String?
  coverImage  String?
  section     ContentSection
  parentSlug  String?         // For nested pages
  order       Int             @default(0)
  isPublished Boolean         @default(true)
  metaTitle   String?
  metaDescription String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([slug])
  @@index([section])
  @@index([isPublished])
}

enum ContentSection {
  WHY_MONGOLIA
  TRAVEL_GUIDE
  ABOUT
  POLICY
}

// ============================================
// SOCIAL MEDIA SETTINGS MODEL
// ============================================
model SiteSettings {
  id              String   @id @default(cuid())
  siteName        String   @default("Maralgoo Dreamland")
  tagline         String?
  email           String?
  phone           String?
  address         String?
  facebookUrl     String?
  instagramUrl    String?
  whatsappNumber  String?
  twitterUrl      String?
  youtubeUrl      String?
  linkedinUrl     String?
  updatedAt       DateTime @updatedAt
}
